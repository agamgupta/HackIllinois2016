<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Speech to Text</title>
  </head>
  <body>

    <p>
      Loaded!
    </p>
    <br><br>
    <p>
       enter language code:
    </p>
    <input type='text' placeholder='en' />

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js'></script>
    <script>
      var waitingForText = false;

      var concatUrl = function(base, q, source, target){
        var url = base+'&q=';
        q_arr = q.split(' ');
        for (var i=0;i<q_arr.length;i++){
          url += q_arr[i];
          if (i < q_arr.length - 1){
            url += '%20';
          }
        }
        url += '&source='+source+'&target='+target;
        return url;
      }

      var recognition = new webkitSpeechRecognition();
      recognition.onresult = function(event) {
        // console.log(event);
        //set flag back to false
        $.post('https://heroku-node-waji.herokuapp.com/facedetect?faceDetectFlag=false');

        var translateUrl = concatUrl('https://www.googleapis.com/language/translate/v2?key=AIzaSyBfrsItManvAhTKiw7RaQJhG1pamN65b18', event.results[0][0].transcript, $('input').val(),'en');

        var translatedText = '';
        $.get(translateUrl,function(res){
          console.log(res);
          translatedText = res.translations.translatedText;
        });
        //send text to server
        $.post('https://heroku-node-waji.herokuapp.com/text',
          {
            'text': translatedText,
            'success': function(){
              console.log('you said '+translatedText.results[0][0].transcript);
              waitingForText = false;
            }
          }
        );
      }

      listenFailureHandler = function(){
        //reset face detect
        $.post('https://heroku-node-waji.herokuapp.com/facedetect?faceDetectFlag=false');
        //send text to server
        $.post('https://heroku-node-waji.herokuapp.com/text',
          {
            'text': '',
            'success': function(){
              console.log('you said ');
              waitingForText = false;
            }
          }
        );
      }

      window.setInterval(function(){
        $.get('https://heroku-node-waji.herokuapp.com/facedetect',function(res){
          console.log(res.faceDetectFlag + ', type ' + typeof(res.faceDetectFlag));
          if (res.faceDetectFlag == 'true' && waitingForText == false){
            recognition.lang = $('input').val();
            console.log(res.faceDetectFlag+', language is '+recognition.lang);
            recognition.start();
            waitingForText = true;

            // window.setTimeout(function(){
            //   listenFailureHandler();
            // }, 2000);
          }
        });
      }, 2000);

    </script>

  </body>
</html>
